# =============================================================================
# Discord Bot - Docker Compose Configuration
# Production deployment with volume mounts and restart policies
# =============================================================================

services:
  bot:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: discord-bot
    restart: unless-stopped

    # Environment configuration
    env_file:
      - ../.env

    environment:
      # Override these in .env or here
      - TZ=Asia/Bangkok
      - PYTHONUNBUFFERED=1

    # Read-only root filesystem for security hardening
    read_only: true

    # Writable tmpfs mounts for runtime data
    tmpfs:
      - /tmp:size=256M
      - /app/__pycache__:size=64M

    # Volume mounts for persistence
    volumes:
      # Persist data directory (database, cache)
      - ../data:/app/data
      # Persist logs
      - ../logs:/app/logs
      # Persist temporary files (optional)
      - ../temp:/app/temp
      # Mount cookies.txt if using YouTube authentication (file must exist)
      # - ../cookies.txt:/app/cookies.txt:ro

    # Health check (uses bot's health API)
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Resource limits
    mem_limit: 4g
    memswap_limit: 4g
    cpus: 2.0
    mem_reservation: 1g

    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

    # Network (optional - for multi-container setups)
    networks:
      - bot-network

# Network definition
networks:
  bot-network:
    driver: bridge

# =============================================================================
# Usage:
#
# Start bot:
#   docker-compose up -d
#
# View logs:
#   docker-compose logs -f bot
#
# Restart bot:
#   docker-compose restart bot
#
# Stop bot:
#   docker-compose down
#
# Rebuild and restart:
#   docker-compose up -d --build
#
# Check health:
#   docker-compose ps
# =============================================================================
